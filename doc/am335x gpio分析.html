<div class="cnblogs_code">
<pre><span style="color: #008000;">/*</span><span style="color: #008000;">***********************************************************************
 *                       am335x_gpio
 *   本文主要记录am335x gpio初始化过程，包括设置引脚复用寄存器，驱动注册。
 *   主要文件：
 *      设备初始化：
 *          arch/arm/mach-omap2/board_am335xevm.c
 *          arch/arm/mach-omap2/io.c
 *          arch/arm/mach-omap2/omap_hwmod_33xx_data.c<br /> *          arch/arm/mach-omap2/mux.c
 *      驱动初始化：
 *          drivers/gpio/gpio-omap.c
 *
 *                                         Tony Liu, 2016-4-30, Shenzhen
 **********************************************************************</span><span style="color: #008000;">*/</span>
<span style="color: #008000;">//</span><span style="color: #008000;">设备注册和初始化</span>
arch/arm/mach-omap2/<span style="color: #000000;">board_am335xevm.c
MACHINE_START(AM335XEVM, </span><span style="color: #800000;">"</span><span style="color: #800000;">am335xevm</span><span style="color: #800000;">"</span><span style="color: #000000;">)
    </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Maintainer: Texas Instruments </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    .atag_offset    </span>= <span style="color: #800080;">0x100</span><span style="color: #000000;">,
    .map_io        </span>=<span style="color: #000000;"> am335x_evm_map_io,
    .init_early    </span>= am33xx_init_early,      --------+　　　　//GPIO寄存器地址指定<span style="color: #000000;">
    .init_irq    </span>= ti81xx_init_irq,                  |<span style="color: #000000;">
    .handle_irq     </span>= omap3_intc_handle_irq,         |<span style="color: #000000;">
    .timer        </span>= &amp;omap3_am33xx_timer,             |<span style="color: #000000;">
    .init_machine    </span>= am335x_evm_init,      --------|------------------------+    //GPIO引脚复用配置<span style="color: #000000;">
MACHINE_END                                          </span>|                        |
                                                     |                        |<span style="color: #000000;">
kernel</span>/arch/arm/mach-omap2/io.c             &lt;--------+                        |
<span style="color: #0000ff;">void</span> __init am33xx_init_early(<span style="color: #0000ff;">void</span>)                                           |<span style="color: #000000;">
{                                                                             </span>|<span style="color: #000000;">
    omap2_set_globals_am33xx();                                               </span>|<span style="color: #000000;">
    omap3xxx_check_revision();                                                </span>|<span style="color: #000000;">
    am33xx_check_features();                                                  </span>|<span style="color: #000000;">
    omap_common_init_early();                                                 </span>|<span style="color: #000000;">
    am33xx_voltagedomains_init();                                             </span>|<span style="color: #000000;">
    omap44xx_prminst_init();                                                  </span>|<span style="color: #000000;">
    am33xx_powerdomains_init();                                               </span>|<span style="color: #000000;">
    omap44xx_cminst_init();                                                   </span>|<span style="color: #000000;">
    am33xx_clockdomains_init();                                               </span>|<span style="color: #000000;">
    am33xx_hwmod_init();                    </span>---------+                        |<span style="color: #000000;">
    omap_hwmod_init_postsetup();                     </span>|                        |<span style="color: #000000;">
    omap3xxx_clk_init();                             </span>|                        |<span style="color: #000000;">
}                                                    </span>|                        |
                                                     |                        |<span style="color: #000000;">
kernel</span>/arch/arm/mach-omap2/omap_hwmod_33xx_data.c    |                        |
<span style="color: #0000ff;">int</span> __init am33xx_hwmod_init(<span style="color: #0000ff;">void</span>)           &lt;-------+                        |<span style="color: #000000;">
{                                                                             </span>|
    <span style="color: #0000ff;">return</span> omap_hwmod_register(am33xx_hwmods);   ---------------------------+ |<span style="color: #000000;">
}                                                                           </span>| |
<span style="color: #008000;">//</span><span style="color: #008000;">将寄存器的信息添加到链表中                                                    | |</span>
<span style="color: #0000ff;">int</span> __init omap_hwmod_register(<span style="color: #0000ff;">struct</span> omap_hwmod **ohs)                     | |<span style="color: #000000;">
{                                                                           </span>| |
    <span style="color: #0000ff;">int</span> r, i;                                                               | |
                                                                            | |
    <span style="color: #0000ff;">if</span> (!ohs)                                                               | |
        <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span>;                                                           | |
                                                                            | |<span style="color: #000000;">
    i </span>= <span style="color: #800080;">0</span>;                                                                  | |
    <span style="color: #0000ff;">do</span> {                                                                    | |<span style="color: #000000;">
        r </span>= _register(ohs[i]);                           -----------------+ | |<span style="color: #000000;">
        WARN(r, </span><span style="color: #800000;">"</span><span style="color: #800000;">omap_hwmod: %s: _register returned %d\n</span><span style="color: #800000;">"</span>, ohs[i]-&gt;name,  | | |<span style="color: #000000;">
             r);                                                          </span>| | |<span style="color: #000000;">
    } </span><span style="color: #0000ff;">while</span> (ohs[++i]);                                                   | | |
                                                                          | | |
    <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span>;                                                             | | |<span style="color: #000000;">
}                                                                         </span>| | |
                                                                          | | |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> __init _register(<span style="color: #0000ff;">struct</span> omap_hwmod *oh)       &lt;----------------+ | |<span style="color: #000000;">
{                                                                           </span>| |
    <span style="color: #0000ff;">int</span> ms_id;                                                              | |
                                                                            | |
    <span style="color: #0000ff;">if</span> (!oh || !oh-&gt;name || !oh-&gt;<span style="color: #0000ff;">class</span> || !oh-&gt;<span style="color: #0000ff;">class</span>-&gt;name ||               | |<span style="color: #000000;">
        (oh</span>-&gt;_state != _HWMOD_STATE_UNKNOWN))                               | |
        <span style="color: #0000ff;">return</span> -EINVAL;                                                     | |
                                                                            | |<span style="color: #000000;">
    pr_debug(</span><span style="color: #800000;">"</span><span style="color: #800000;">omap_hwmod: %s: registering\n</span><span style="color: #800000;">"</span>, oh-&gt;name);                    | |
    <span style="color: #008000;">//</span><span style="color: #008000;">查找这个结构是否已经添加到双链中                                           | |</span>
    <span style="color: #0000ff;">if</span> (_lookup(oh-&gt;name))                                                  | |
        <span style="color: #0000ff;">return</span> -EEXIST;                                                     | |
                                                                            | |<span style="color: #000000;">
    ms_id </span>= _find_mpu_port_index(oh);                    --------------+    | |
    <span style="color: #0000ff;">if</span> (!IS_ERR_VALUE(ms_id))                                          |    | |<span style="color: #000000;">
        oh</span>-&gt;_mpu_port_index = ms_id;                                   |    | |
    <span style="color: #0000ff;">else</span>                                                               |    | |<span style="color: #000000;">
        oh</span>-&gt;_int_flags |= _HWMOD_NO_MPU_PORT;                          |    | |
                                                                       |    | |<span style="color: #000000;">
    list_add_tail(</span>&amp;oh-&gt;node, &amp;omap_hwmod_list);                        |    | |
                                                                       |    | |<span style="color: #000000;">
    spin_lock_init(</span>&amp;oh-&gt;_lock);                                        |    | |
                                                                       |    | |<span style="color: #000000;">
    oh</span>-&gt;_state = _HWMOD_STATE_REGISTERED;                              |    | |
                                                                       |    | |
    <span style="color: #008000;">/*</span><span style="color: #008000;">                                                                 |    | |
     * XXX Rather than doing a strcmp(), this should test a flag       |    | |
     * set in the hwmod data, inserted by the autogenerator code.      |    | |
     </span><span style="color: #008000;">*/</span>                                                                |    | |
    <span style="color: #0000ff;">if</span> (!strcmp(oh-&gt;name, MPU_INITIATOR_NAME))                         |    | |<span style="color: #000000;">
        mpu_oh </span>= oh;                                                   |    | |
                                                                       |    | |
    <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span>;                                                          |    | |<span style="color: #000000;">
}                                                                      </span>|    | |
                                                                       |    | |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> __init _find_mpu_port_index(<span style="color: #0000ff;">struct</span> omap_hwmod *oh)     &lt;----+    | |<span style="color: #000000;">
{                                                                           </span>| |
    <span style="color: #0000ff;">int</span> i;                                                                  | |
    <span style="color: #0000ff;">int</span> found = <span style="color: #800080;">0</span>;                                                          | |
                                                                            | |
    <span style="color: #0000ff;">if</span> (!oh || oh-&gt;slaves_cnt == <span style="color: #800080;">0</span>)                                         | |
        <span style="color: #0000ff;">return</span> -EINVAL;                                                     | |
                                                                            | |
    <span style="color: #0000ff;">for</span> (i = <span style="color: #800080;">0</span>; i &lt; oh-&gt;slaves_cnt; i++) {                                  | |
        <span style="color: #0000ff;">struct</span> omap_hwmod_ocp_if *os = oh-&gt;slaves[i];                       | |
                                                                            | |
        <span style="color: #0000ff;">if</span> (os-&gt;user &amp; OCP_USER_MPU) {                                      | |<span style="color: #000000;">
            found </span>= <span style="color: #800080;">1</span>;                                                      | |
            <span style="color: #0000ff;">break</span>;                                                          | |<span style="color: #000000;">
        }                                                                   </span>| |<span style="color: #000000;">
    }                                                                       </span>| |
                                                                            | |
    <span style="color: #0000ff;">if</span> (found)                                                              | |<span style="color: #000000;">
        pr_debug(</span><span style="color: #800000;">"</span><span style="color: #800000;">omap_hwmod: %s: MPU OCP slave port ID  %d\n</span><span style="color: #800000;">"</span>,             | |<span style="color: #000000;">
             oh</span>-&gt;name, i);                                                  | |
    <span style="color: #0000ff;">else</span>                                                                    | |<span style="color: #000000;">
        pr_debug(</span><span style="color: #800000;">"</span><span style="color: #800000;">omap_hwmod: %s: no MPU OCP slave port found\n</span><span style="color: #800000;">"</span>,           | |<span style="color: #000000;">
             oh</span>-&gt;name);                                                     | |
                                                                            | |
    <span style="color: #0000ff;">return</span> (found) ? i : -EINVAL;                                           | |<span style="color: #000000;">
}                                                                           </span>| |
                                                                            | |
                                                                            | |
<span style="color: #008000;">//</span><span style="color: #008000;">gpio                                                                      | |</span>
<span style="color: #0000ff;">static</span> __initdata <span style="color: #0000ff;">struct</span> omap_hwmod *am33xx_hwmods[] = {         &lt;----------+ |<span style="color: #000000;">
    ......                                                                    </span>|
    <span style="color: #008000;">/*</span><span style="color: #008000;"> gpio class </span><span style="color: #008000;">*/</span>                                                          |
    &amp;am33xx_gpio0_hwmod,                                                      |
    &amp;am33xx_gpio1_hwmod,      -----+                                          |
    &amp;am33xx_gpio2_hwmod,           |                                          |
    &amp;am33xx_gpio3_hwmod,           |                                          |<span style="color: #000000;">
    ......                         </span>|                                          |<span style="color: #000000;">
};                                 </span>|                                          |<span style="color: #000000;">
                                   V                                          </span>|
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod am33xx_gpio1_hwmod = {                               |<span style="color: #000000;">
    .name        </span>= <span style="color: #800000;">"</span><span style="color: #800000;">gpio2</span><span style="color: #800000;">"</span>,                                                   |<span style="color: #000000;">
    .</span><span style="color: #0000ff;">class</span>        = &amp;am33xx_gpio_hwmod_class,      ------------------+        |<span style="color: #000000;">
    .clkdm_name    </span>= <span style="color: #800000;">"</span><span style="color: #800000;">l4ls_clkdm</span><span style="color: #800000;">"</span>,                                   |        |<span style="color: #000000;">
    .mpu_irqs    </span>= am33xx_gpio1_irqs,              ----------------+ |        |<span style="color: #000000;">
    .main_clk    </span>= <span style="color: #800000;">"</span><span style="color: #800000;">gpio1_ick</span><span style="color: #800000;">"</span>,                                    | |        |<span style="color: #000000;">
    .flags        </span>= HWMOD_CONTROL_OPT_CLKS_IN_RESET,               | |        |<span style="color: #000000;">
    .prcm        </span>= {                                               | |        |<span style="color: #000000;">
        .omap4    </span>= {                                              | |        |<span style="color: #000000;">
            .clkctrl_offs    </span>= AM33XX_CM_PER_GPIO1_CLKCTRL_OFFSET, | |        |<span style="color: #000000;">
            .modulemode    </span>= MODULEMODE_SWCTRL,                    | |        |<span style="color: #000000;">
        },                                                         </span>| |        |<span style="color: #000000;">
    },                                                             </span>| |        |<span style="color: #000000;">
    .opt_clks    </span>= gpio1_opt_clks,              ----------+        | |        |<span style="color: #000000;">
    .opt_clks_cnt    </span>= ARRAY_SIZE(gpio1_opt_clks),        |        | |        |<span style="color: #000000;">
    .dev_attr    </span>= &amp;gpio_dev_attr,              ------+   |        | |        |<span style="color: #000000;">
    .slaves        </span>= am33xx_gpio1_slaves,       ------|---|--------| |-+      |<span style="color: #000000;">
    .slaves_cnt    </span>= ARRAY_SIZE(am33xx_gpio1_slaves), |   |        | | |      |<span style="color: #000000;">
};                                                    </span>|   |        | | |      |
                                                      |   |        | | |      |
                                                      |   |        | | |      |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_gpio_dev_attr gpio_dev_attr = { &lt;--+   |        | | |      |<span style="color: #000000;">
    .bank_width    </span>= <span style="color: #800080;">32</span>,                                  |        | | |      |<span style="color: #000000;">
    .dbck_flag    </span>= <span style="color: #0000ff;">true</span>,                                 |        | | |      |<span style="color: #000000;">
};                                                        </span>|        | | |      |
                                                          |        | | |      |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_opt_clk gpio1_opt_clks[] = {  &lt;--+        | | |      |<span style="color: #000000;">
    { .role </span>= <span style="color: #800000;">"</span><span style="color: #800000;">dbclk</span><span style="color: #800000;">"</span>, .clk = <span style="color: #800000;">"</span><span style="color: #800000;">gpio1_dbclk</span><span style="color: #800000;">"</span> },                     | | |      |<span style="color: #000000;">
};                                                                 </span>| | |      |
                                                                   | | |      |
<span style="color: #008000;">//</span><span style="color: #008000;">指定irq中断号,和芯片手册中一样                                       | | |      |</span>
                                                                   | | |      |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_irq_info am33xx_gpio1_irqs[] = {    &lt;-----+ | |      |<span style="color: #000000;">
    { .irq </span>= <span style="color: #800080;">98</span> },                                                   | |      |<span style="color: #000000;">
    { .irq </span>= -<span style="color: #800080;">1</span> }                                                    | |      |<span style="color: #000000;">
};                                                                   </span>| |      |
                                                                     | |      |
<span style="color: #008000;">//</span><span style="color: #008000;">所有的GPIO都有相同的am33xx_gpio_hwmod_class                          | |      |</span>
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_class am33xx_gpio_hwmod_class = {     &lt;-----+ |      |<span style="color: #000000;">
    .name        </span>= <span style="color: #800000;">"</span><span style="color: #800000;">gpio</span><span style="color: #800000;">"</span>,                                             |      |<span style="color: #000000;">
    .sysc        </span>= &amp;am33xx_gpio_sysc,                      ----------+ |      |<span style="color: #000000;">
    .rev        </span>= <span style="color: #800080;">2</span>,                                                 | |      |<span style="color: #000000;">
};                                                                   </span>| |      |
                                                                     | |      |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_class_sysconfig am33xx_gpio_sysc = {    &lt;---+ |      |<span style="color: #000000;">
    .rev_offs    </span>= <span style="color: #800080;">0x0000</span>,    <span style="color: #008000;">//</span><span style="color: #008000;">GPIO_REVISION 寄存器                    |      |</span>
    .sysc_offs    = <span style="color: #800080;">0x0010</span>,    <span style="color: #008000;">//</span><span style="color: #008000;">GPIO_SYSCONFIG                        |      |</span>
    .syss_offs    = <span style="color: #800080;">0x0114</span>,    <span style="color: #008000;">//</span><span style="color: #008000;">GPIO_SYSSTATUS                        |      |</span>
    .sysc_flags    = (SYSC_HAS_AUTOIDLE | SYSC_HAS_ENAWAKEUP |         |      |<span style="color: #000000;">
               SYSC_HAS_SIDLEMODE </span>| SYSC_HAS_SOFTRESET |               |      |<span style="color: #000000;">
               SYSS_HAS_RESET_STATUS),                                 </span>|      |<span style="color: #000000;">
    .idlemodes    </span>= (SIDLE_FORCE | SIDLE_NO | SIDLE_SMART |            |      |<span style="color: #000000;">
            SIDLE_SMART_WKUP),                                         </span>|      |<span style="color: #000000;">
    .sysc_fields    </span>= &amp;omap_hwmod_sysc_type1,  ---+                    |      |<span style="color: #000000;">
};                                                </span>|                    |      |<span style="color: #000000;">
                                                  V                    </span>|      |
<span style="color: #0000ff;">struct</span> omap_hwmod_sysc_fields omap_hwmod_sysc_type1 = {                |      |<span style="color: #000000;">
    .midle_shift    </span>= SYSC_TYPE1_MIDLEMODE_SHIFT,                      |      |<span style="color: #000000;">
    .clkact_shift    </span>= SYSC_TYPE1_CLOCKACTIVITY_SHIFT,                 |      |<span style="color: #000000;">
    .sidle_shift    </span>= SYSC_TYPE1_SIDLEMODE_SHIFT,                      |      |<span style="color: #000000;">
    .enwkup_shift    </span>= SYSC_TYPE1_ENAWAKEUP_SHIFT,                     |      |<span style="color: #000000;">
    .srst_shift    </span>= SYSC_TYPE1_SOFTRESET_SHIFT,                       |      |<span style="color: #000000;">
    .autoidle_shift    </span>= SYSC_TYPE1_AUTOIDLE_SHIFT,                    |      |<span style="color: #000000;">
};                                                                     </span>|      |
                                                                       |      |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_ocp_if *am33xx_gpio1_slaves[] = {      &lt;------+      |
    &amp;am33xx_l4_per__gpio1,       ----+                                        |<span style="color: #000000;">
};                                   </span>|                                        |<span style="color: #000000;">
                                     V                                        </span>|
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_ocp_if am33xx_l4_per__gpio1 = {                      |<span style="color: #000000;">
    .master        </span>= &amp;am33xx_l4per_hwmod,   ---------+                        |<span style="color: #000000;">
    .slave        </span>= &amp;am33xx_gpio1_hwmod,             |                        |<span style="color: #000000;">
    .clk        </span>= <span style="color: #800000;">"</span><span style="color: #800000;">l4ls_gclk</span><span style="color: #800000;">"</span>,                       |                        |<span style="color: #000000;">
    .addr        </span>= am33xx_gpio1_addrs,               |                        |<span style="color: #000000;">
    .user        </span>= OCP_USER_MPU | OCP_USER_SDMA,     |                        |<span style="color: #000000;">
};                                                   </span>|                        |
                                                     |                        |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod am33xx_l4per_hwmod = {   &lt;--+                        |<span style="color: #000000;">
    .name        </span>= <span style="color: #800000;">"</span><span style="color: #800000;">l4_per</span><span style="color: #800000;">"</span>,                                                  |<span style="color: #000000;">
    .</span><span style="color: #0000ff;">class</span>        = &amp;l4_hwmod_class,                                          |<span style="color: #000000;">
    .clkdm_name    </span>= <span style="color: #800000;">"</span><span style="color: #800000;">l4ls_clkdm</span><span style="color: #800000;">"</span>,                                            |<span style="color: #000000;">
    .flags        </span>= (HWMOD_INIT_NO_IDLE | HWMOD_INIT_NO_RESET),               |<span style="color: #000000;">
    .masters    </span>= am33xx_l4_per_masters,      -----------------+              |<span style="color: #000000;">
    .masters_cnt    </span>= ARRAY_SIZE(am33xx_l4_per_masters),       |              |<span style="color: #000000;">
    .slaves        </span>= am33xx_l4_per_slaves,         ------------|--+           |<span style="color: #000000;">
    .slaves_cnt    </span>= ARRAY_SIZE(am33xx_l4_per_slaves),         |  |           |<span style="color: #000000;">
};                                                             </span>|  |           |
                                                               |  |           |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_ocp_if *am33xx_l4_per_masters[] = { &lt;-+  |           |
    &amp;am33xx_l4_per__dcan0,                                        |           |
    &amp;am33xx_l4_per__dcan1,                                        |           |
    &amp;am33xx_l4_per__gpio1,                                        |           |
    &amp;am33xx_l4_per__gpio2,            ------+                     |           |
    &amp;am33xx_l4_per__gpio3,                  |                     |           |<span style="color: #000000;">
};                                          </span>|                     |           |<span style="color: #000000;">
                                            V                     </span>|           |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_ocp_if am33xx_l4_per__gpio2 = {          |           |<span style="color: #000000;">
    .master        </span>= &amp;am33xx_l4per_hwmod,                         |           |<span style="color: #000000;">
    .slave        </span>= &amp;am33xx_gpio2_hwmod,                          |           |<span style="color: #000000;">
    .clk        </span>= <span style="color: #800000;">"</span><span style="color: #800000;">l4ls_gclk</span><span style="color: #800000;">"</span>,                                    |           |<span style="color: #000000;">
    .addr        </span>= am33xx_gpio2_addrs,  ----------+               |           |<span style="color: #000000;">
    .user        </span>= OCP_USER_MPU | OCP_USER_SDMA,  |               |           |<span style="color: #000000;">
};                                                </span>|               |           |
                                                  |               |           |
<span style="color: #008000;">/*</span><span style="color: #008000;"> L4 PER -&gt; GPIO2 </span><span style="color: #008000;">*/</span>                             V               |           |
<span style="color: #008000;">//</span><span style="color: #008000;">GPIO2对应的寄存器地址                                             |           |</span>
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_addr_space am33xx_gpio2_addrs[] = {      |           |<span style="color: #000000;">
    {                                                             </span>|           |<span style="color: #000000;">
        .pa_start    </span>= <span style="color: #800080;">0x481AC000</span>,                                |           |<span style="color: #000000;">
        .pa_end        </span>= <span style="color: #800080;">0x481AC000</span> + SZ_4K - <span style="color: #800080;">1</span>,                  |           |<span style="color: #000000;">
        .flags        </span>= ADDR_TYPE_RT,                             |           |<span style="color: #000000;">
    },                                                            </span>|           |<span style="color: #000000;">
    { }                                                           </span>|           |<span style="color: #000000;">
};                                                                </span>|           |
                                                                  |           |
<span style="color: #008000;">/*</span><span style="color: #008000;"> Slave interfaces on the L4_PER interconnect </span><span style="color: #008000;">*/</span>                 |           |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_ocp_if *am33xx_l4_per_slaves[] = {    &lt;--+           |
    &amp;am33xx_l3_slow__l4_per,    -----+                                        |<span style="color: #000000;">
};                                   </span>|                                        |<span style="color: #000000;">
                                     V                                        </span>|
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> omap_hwmod_ocp_if am33xx_l3_slow__l4_per = {                    |<span style="color: #000000;">
    .master     </span>= &amp;am33xx_l3slow_hwmod,                                       |<span style="color: #000000;">
    .slave        </span>= &amp;am33xx_l4per_hwmod,                                      |<span style="color: #000000;">
    .user        </span>= OCP_USER_MPU,                                              |<span style="color: #000000;">
};                                                                            </span>|
                                                                              |
<span style="color: #008000;">//</span><span style="color: #008000;">GPIO引脚复用配置                                                              |</span>
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> __init am335x_evm_init(<span style="color: #0000ff;">void</span>)                 &lt;--------------------+<span style="color: #000000;">
{
    am33xx_cpuidle_init();
    am33xx_mux_init(board_mux);
    omap_serial_init();
    am335x_evm_i2c_init();
    omap_sdrc_init(NULL, NULL);
    usb_musb_init(</span>&amp;<span style="color: #000000;">musb_board_data);

    omap_board_config </span>=<span style="color: #000000;"> am335x_evm_config;
    omap_board_config_size </span>=<span style="color: #000000;"> ARRAY_SIZE(am335x_evm_config);

    daughter_brd_detected </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;">自己定义的函数</span>
    setup_xxx_xxxx();                                           --------------+
                                                                              |
    <span style="color: #008000;">/*</span><span style="color: #008000;">create  /proc/boardname to export info to userspace</span><span style="color: #008000;">*/</span>                   |<span style="color: #000000;">
    proc_init();                                                              </span>|
                                                                              |
    <span style="color: #008000;">/*</span><span style="color: #008000;"> Create an alias for icss clock </span><span style="color: #008000;">*/</span>                                      |
    <span style="color: #0000ff;">if</span> (clk_add_alias(<span style="color: #800000;">"</span><span style="color: #800000;">pruss</span><span style="color: #800000;">"</span>, NULL, <span style="color: #800000;">"</span><span style="color: #800000;">pruss_uart_gclk</span><span style="color: #800000;">"</span>, NULL))                |<span style="color: #000000;">
        pr_warn(</span><span style="color: #800000;">"</span><span style="color: #800000;">failed to create an alias: icss_uart_gclk --&gt; pruss\n</span><span style="color: #800000;">"</span>);     |
    <span style="color: #008000;">/*</span><span style="color: #008000;"> Create an alias for gfx/sgx clock </span><span style="color: #008000;">*/</span>                                   |
    <span style="color: #0000ff;">if</span> (clk_add_alias(<span style="color: #800000;">"</span><span style="color: #800000;">sgx_ck</span><span style="color: #800000;">"</span>, NULL, <span style="color: #800000;">"</span><span style="color: #800000;">gfx_fclk</span><span style="color: #800000;">"</span>, NULL))                      |<span style="color: #000000;">
        pr_warn(</span><span style="color: #800000;">"</span><span style="color: #800000;">failed to create an alias: gfx_fclk --&gt; sgx_ck\n</span><span style="color: #800000;">"</span>);          |<span style="color: #000000;">
}                                                                             </span>|
                                                                              |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> setup_xxx_xxxx(<span style="color: #0000ff;">void</span>)                                &lt;-------------+<span style="color: #000000;">
{
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">which doesn't have Write Protect pin LAN8710A_PHY_ID </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    am335x_mmc[</span><span style="color: #800080;">0</span>].gpio_wp = -<span style="color: #000000;">EINVAL;

    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> ret;
                                      </span>+-----------------------------------------+
    <span style="color: #008000;">//</span><span style="color: #008000;">配置设备所有引脚复用               |                                         |</span>
    _configure_device(EVM_SK, xxx_xxxx_dev_cfg, PROFILE_NONE);     ----------+  |
    <span style="color: #008000;">//</span><span style="color: #008000;">phy配置                                                                 |  |</span>
    am33xx_cpsw_init(AM33XX_CPSW_MODE_MII, xxx_xxxx_phy1, xxx_xxxx_phy2);    |  |<span style="color: #000000;">
    phy_register_fixup_for_uid(LAN8710A_PHY_ID , AM335X_EVM_PHY_MASK,        </span>|  |<span style="color: #000000;">
                                 am33xx_evm_tx_clk_dly_phy_fixup);           </span>|  |<span style="color: #000000;">
}                                                                            </span>|  |
                                                                             |  |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> _configure_device(<span style="color: #0000ff;">int</span> evm_id, <span style="color: #0000ff;">struct</span> evm_dev_cfg *dev_cfg,   &lt;---+  |
    <span style="color: #0000ff;">int</span> profile)                                                                |<span style="color: #000000;">
{                                                                               </span>|
    <span style="color: #0000ff;">int</span> i;                                                                      |
                                                                                |<span style="color: #000000;">
    am335x_evm_set_id(evm_id);                                                  </span>|
                                                                                |
    <span style="color: #008000;">//</span><span style="color: #008000;">循环调用结构体数组的初始化函数，设置引脚复用                                    |</span>
    <span style="color: #0000ff;">if</span> (profile == PROFILE_NONE) {                                              |
        <span style="color: #0000ff;">for</span> (i = <span style="color: #800080;">0</span>; dev_cfg-&gt;device_init != NULL; dev_cfg++) {                  |
            <span style="color: #0000ff;">if</span> (dev_cfg-&gt;device_on == DEV_ON_BASEBOARD)                         |<span style="color: #000000;">
                dev_cfg</span>-&gt;device_init(evm_id, profile);                          |
            <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (daughter_brd_detected == <span style="color: #0000ff;">true</span>)                             |<span style="color: #000000;">
                dev_cfg</span>-&gt;device_init(evm_id, profile);                          |<span style="color: #000000;">
        }                                                                       </span>|<span style="color: #000000;">
    } </span><span style="color: #0000ff;">else</span> {                                                                    |
        <span style="color: #0000ff;">for</span> (i = <span style="color: #800080;">0</span>; dev_cfg-&gt;device_init != NULL; dev_cfg++) {                  |
            <span style="color: #0000ff;">if</span> (dev_cfg-&gt;profile &amp; profile) {                                   |
                <span style="color: #0000ff;">if</span> (dev_cfg-&gt;device_on == DEV_ON_BASEBOARD)                     |<span style="color: #000000;">
                    dev_cfg</span>-&gt;device_init(evm_id, profile);                      |
                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (daughter_brd_detected == <span style="color: #0000ff;">true</span>)                         |<span style="color: #000000;">
                    dev_cfg</span>-&gt;device_init(evm_id, profile);                      |<span style="color: #000000;">
            }                                                                   </span>|<span style="color: #000000;">
        }                                                                       </span>|<span style="color: #000000;">
    }                                                                           </span>|<span style="color: #000000;">
}                                                                               </span>|
                                                                                |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> evm_dev_cfg xxx_xxxx_dev_cfg[] = {                   &lt;------------+<span style="color: #000000;">
    ......
    {gpio_keys_init_forlinx,  DEV_ON_BASEBOARD, PROFILE_ALL},
    {gpio_led_init,  DEV_ON_BASEBOARD, PROFILE_ALL},          </span>---------+<span style="color: #000000;">
    ......                                                             </span>|<span style="color: #000000;">
    {NULL, </span><span style="color: #800080;">0</span>, <span style="color: #800080;">0</span>},                                                      |<span style="color: #000000;">
};                                                                     </span>|
                                                                       |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> gpio_led_init(<span style="color: #0000ff;">int</span> evm_id, <span style="color: #0000ff;">int</span> profile)             &lt;-------+<span style="color: #000000;">
{
    </span><span style="color: #0000ff;">int</span> err;             +--------------------------------+
                         |                                |<span style="color: #000000;">
    setup_pin_mux(gpio_led_mux);            </span>--------------|----------+<span style="color: #000000;">
    err </span>= platform_device_register(&amp;leds_gpio);   --------|----------|------------------+
    <span style="color: #0000ff;">if</span> (err)                                              |          |                  |<span style="color: #000000;">
        pr_err(</span><span style="color: #800000;">"</span><span style="color: #800000;">failed to register gpio led device\n</span><span style="color: #800000;">"</span>);   |          |                  |<span style="color: #000000;">
}                                                         </span>|          |                  |
                                                          |          |                  |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> pinmux_config gpio_led_mux[] = {      &lt;-----+          |                  |<span style="color: #000000;">
    {</span><span style="color: #800000;">"</span><span style="color: #800000;">gpmc_a0.gpio1_16</span><span style="color: #800000;">"</span>, OMAP_MUX_MODE7 | AM33XX_PIN_INPUT},         |                  |<span style="color: #000000;">
    {</span><span style="color: #800000;">"</span><span style="color: #800000;">gpmc_a1.gpio1_17</span><span style="color: #800000;">"</span>, OMAP_MUX_MODE7 | AM33XX_PIN_INPUT},         |                  |<span style="color: #000000;">
    {</span><span style="color: #800000;">"</span><span style="color: #800000;">gpmc_a2.gpio1_18</span><span style="color: #800000;">"</span>, OMAP_MUX_MODE7 | AM33XX_PIN_INPUT},         |                  |<span style="color: #000000;">
    {</span><span style="color: #800000;">"</span><span style="color: #800000;">gpmc_a3.gpio1_19</span><span style="color: #800000;">"</span>, OMAP_MUX_MODE7 | AM33XX_PIN_INPUT},         |                  |<span style="color: #000000;">
    {</span><span style="color: #800000;">"</span><span style="color: #800000;">emu1.gpio3_8</span><span style="color: #800000;">"</span>, OMAP_MUX_MODE7 | AM33XX_PIN_INPUT},             |                  |<span style="color: #000000;">
    {NULL, </span><span style="color: #800080;">0</span>},                                                       |                  |<span style="color: #000000;">
};                                                                   </span>|                  |
                                                                     |                  |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> setup_pin_mux(<span style="color: #0000ff;">struct</span> pinmux_config *pin_mux)     &lt;-------+                  |<span style="color: #000000;">
{                                                                                       </span>|
    <span style="color: #0000ff;">int</span> i;                                                                              |
    <span style="color: #008000;">//</span><span style="color: #008000;">初始化                                                                             |</span>
    <span style="color: #0000ff;">for</span> (i = <span style="color: #800080;">0</span>; pin_mux-&gt;string_name != NULL; pin_mux++)                                |<span style="color: #000000;">
        omap_mux_init_signal(pin_mux</span>-&gt;string_name, pin_mux-&gt;val);  ---+                 |
                                                                      |                 |<span style="color: #000000;">
}                                                                     </span>|                 |
                                                                      |                 |<span style="color: #000000;">
arch</span>/arm/mach-omap2/mux.c                                             |                 |
<span style="color: #0000ff;">int</span> __init omap_mux_init_signal(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *muxname, <span style="color: #0000ff;">int</span> val)     &lt;---+                 |<span style="color: #000000;">
{                                                                                       </span>|
    <span style="color: #0000ff;">struct</span> omap_mux_partition *partition = NULL;                                        |
    <span style="color: #0000ff;">struct</span> omap_mux *mux = NULL;                                                        |<span style="color: #000000;">
    u16 old_mode;                                                                       </span>|
    <span style="color: #0000ff;">int</span> mux_mode;                                                                       |
    <span style="color: #008000;">//</span><span style="color: #008000;">确认muxname字符窜中配置的模式是否存在                                                 |</span>
    mux_mode = omap_mux_get_by_name(muxname, &amp;partition, &amp;mux);   ----+                 |
    <span style="color: #0000ff;">if</span> (mux_mode &lt; <span style="color: #800080;">0</span>)                                                 |                 |
        <span style="color: #0000ff;">return</span> mux_mode;                                              |                 |
    <span style="color: #008000;">//</span><span style="color: #008000;">读取旧的模式                                                      |                 |</span>
    old_mode = omap_mux_read(partition, mux-&gt;reg_offset);        -----|------------+    |<span style="color: #000000;">
    mux_mode </span>|= val;                                                  |            |    |<span style="color: #000000;">
    pr_debug(</span><span style="color: #800000;">"</span><span style="color: #800000;">%s: Setting signal %s 0x%04x -&gt; 0x%04x\n</span><span style="color: #800000;">"</span>,              |            |    |<span style="color: #000000;">
             __func__, muxname, old_mode, mux_mode);                  </span>|            |    |
    <span style="color: #008000;">//</span><span style="color: #008000;">将模式和至写入寄存器中,配置引脚复用                                  |            |    |</span>
    omap_mux_write(partition, mux_mode, mux-&gt;reg_offset);        -----|------------|--+ |
                                                                      |            |  | |
    <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span>;                                                         |            |  | |<span style="color: #000000;">
}                                                                     </span>|            |  | |
                                                                      |            |  | |<span style="color: #000000;">
arch</span>/arm/mach-omap2/mux.c                                             |            |  | |
<span style="color: #0000ff;">int</span> omap_mux_get_by_name(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *muxname,                   &lt;-----+            |  | |
            <span style="color: #0000ff;">struct</span> omap_mux_partition **found_partition,                           |  | |
            <span style="color: #0000ff;">struct</span> omap_mux **found_mux)                                           |  | |<span style="color: #000000;">
{                                                                                  </span>|  | |
    <span style="color: #0000ff;">struct</span> omap_mux_partition *partition;    +---------------------------+         |  | |
                                             |                           |         |  | |<span style="color: #000000;">
    list_for_each_entry(partition, </span>&amp;mux_partitions, node) {              |         |  | |
        <span style="color: #0000ff;">struct</span> omap_mux *mux = NULL;                                     |         |  | |
        <span style="color: #0000ff;">int</span> mux_mode = _omap_mux_get_by_name(partition, muxname, &amp;mux);  | -----+  |  | |
        <span style="color: #0000ff;">if</span> (mux_mode &lt; <span style="color: #800080;">0</span>)                                                |      |  |  | |
            <span style="color: #0000ff;">continue</span>;                                                    |      |  |  | |
                                                                         |      |  |  | |
        *found_partition = partition;                                    |      |  |  | |
        *found_mux = mux;                                                |      |  |  | |
                                                                         |      |  |  | |
        <span style="color: #0000ff;">return</span> mux_mode;                                                 |      |  |  | |<span style="color: #000000;">
    }                                                                    </span>|      |  |  | |
                                                                         |      |  |  | |
    <span style="color: #0000ff;">return</span> -ENODEV;                                                      |      |  |  | |<span style="color: #000000;">
}                                                                        </span>|      |  |  | |
                                                                         |      |  |  | |
<span style="color: #0000ff;">static</span> LIST_HEAD(mux_partitions);               &lt;------------------------+      |  |  | |
                                                                                |  |  | |
                                                                                |  |  | |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> __init _omap_mux_get_by_name(<span style="color: #0000ff;">struct</span> omap_mux_partition *partition, &lt;-+  |  | |
                    <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *muxname,                                           |  | |
                    <span style="color: #0000ff;">struct</span> omap_mux **found_mux)                                   |  | |<span style="color: #000000;">
{                                                                                  </span>|  | |
    <span style="color: #0000ff;">struct</span> omap_mux *mux = NULL;                                                   |  | |
    <span style="color: #0000ff;">struct</span> omap_mux_entry *e;                                                      |  | |
    <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *mode_name;                                                         |  | |
    <span style="color: #0000ff;">int</span> found = <span style="color: #800080;">0</span>, found_mode = <span style="color: #800080;">0</span>, mode0_len = <span style="color: #800080;">0</span>;                                  |  | |
    <span style="color: #0000ff;">struct</span> list_head *muxmodes = &amp;partition-&gt;muxmodes;                             |  | |
    <span style="color: #008000;">//</span><span style="color: #008000;">查找模块的名字,例如"gpmc_a0.gpio1_16",名字是 gpio1_16                            |  | |</span>
    mode_name = strchr(muxname, <span style="color: #800000;">'</span><span style="color: #800000;">.</span><span style="color: #800000;">'</span>);                                              |  | |
    <span style="color: #0000ff;">if</span> (mode_name) {                                                               |  | |<span style="color: #000000;">
        mode0_len </span>= strlen(muxname) - strlen(mode_name);                           |  | |<span style="color: #000000;">
        mode_name</span>++;                                                               |  | |<span style="color: #000000;">
    } </span><span style="color: #0000ff;">else</span> {                                                                       |  | |<span style="color: #000000;">
        mode_name </span>= muxname;                                                       |  | |<span style="color: #000000;">
    }                                                                              </span>|  | |
                                                                                   |  | |<span style="color: #000000;">
    list_for_each_entry(e, muxmodes, node) {                                       </span>|  | |
        <span style="color: #0000ff;">char</span> *m0_entry;                                                            |  | |
        <span style="color: #0000ff;">int</span> i;                                                                     |  | |
                                                                                   |  | |<span style="color: #000000;">
        mux </span>= &amp;e-&gt;mux;                                                             |  | |<span style="color: #000000;">
        m0_entry </span>= mux-&gt;muxnames[<span style="color: #800080;">0</span>];                                               |  | |
        <span style="color: #008000;">//</span><span style="color: #008000;">查找例如&ldquo;gpmc_a0.gpio1_16"中，是否存在 gpmc_a0这个默认的模式0                 |  | |</span>
        <span style="color: #008000;">/*</span><span style="color: #008000;"> First check for full name in mode0.muxmode format </span><span style="color: #008000;">*/</span>                    |  | |
        <span style="color: #0000ff;">if</span> (mode0_len &amp;&amp; strncmp(muxname, m0_entry, mode0_len))                    |  | |
            <span style="color: #0000ff;">continue</span>;                                                              |  | |
        <span style="color: #008000;">/*</span><span style="color: #008000;"> 按照模式名称进行匹配，查找这个引脚是否有对应名称的模式                          |  | |
         * 例如&ldquo;gpio1_16",如果存在，返回模式对应的index                                |  | |
         </span><span style="color: #008000;">*/</span>                                                                        |  | |
        <span style="color: #008000;">/*</span><span style="color: #008000;"> Then check for muxmode only </span><span style="color: #008000;">*/</span>                                          |  | |
        <span style="color: #0000ff;">for</span> (i = <span style="color: #800080;">0</span>; i &lt; OMAP_MUX_NR_MODES; i++) {                                  |  | |
            <span style="color: #0000ff;">char</span> *mode_cur = mux-&gt;muxnames[i];                                     |  | |
                                                                                   |  | |
            <span style="color: #0000ff;">if</span> (!mode_cur)                                                         |  | |
                <span style="color: #0000ff;">continue</span>;                                                          |  | |
                                                                                   |  | |
            <span style="color: #0000ff;">if</span> (!strcmp(mode_name, mode_cur)) {                                    |  | |
                *found_mux = mux;                                                  |  | |<span style="color: #000000;">
                found</span>++;                                                           |  | |<span style="color: #000000;">
                found_mode </span>= i;                                                    |  | |<span style="color: #000000;">
            }                                                                      </span>|  | |<span style="color: #000000;">
        }                                                                          </span>|  | |<span style="color: #000000;">
    }                                                                              </span>|  | |
                                                                                   |  | |
    <span style="color: #0000ff;">if</span> (found == <span style="color: #800080;">1</span>) {                                                              |  | |
        <span style="color: #0000ff;">return</span> found_mode;                                                         |  | |<span style="color: #000000;">
    }                                                                              </span>|  | |
                                                                                   |  | |
    <span style="color: #0000ff;">if</span> (found &gt; <span style="color: #800080;">1</span>) {                                                               |  | |<span style="color: #000000;">
        pr_err(</span><span style="color: #800000;">"</span><span style="color: #800000;">%s: Multiple signal paths (%i) for %s\n</span><span style="color: #800000;">"</span>, __func__,                |  | |<span style="color: #000000;">
               found, muxname);                                                    </span>|  | |
        <span style="color: #0000ff;">return</span> -EINVAL;                                                            |  | |<span style="color: #000000;">
    }                                                                              </span>|  | |
                                                                                   |  | |<span style="color: #000000;">
    pr_err(</span><span style="color: #800000;">"</span><span style="color: #800000;">%s: Could not find signal %s\n</span><span style="color: #800000;">"</span>, __func__, muxname);                   |  | |
                                                                                   |  | |
    <span style="color: #0000ff;">return</span> -ENODEV;                                                                |  | |<span style="color: #000000;">
}                                                                                  </span>|  | |
                                                                                   |  | |<span style="color: #000000;">
u16 omap_mux_read(</span><span style="color: #0000ff;">struct</span> omap_mux_partition *partition, u16 reg)          &lt;--------+  | |<span style="color: #000000;">
{                                                                                     </span>| |
    <span style="color: #0000ff;">if</span> (partition-&gt;flags &amp; OMAP_MUX_REG_8BIT)                                         | |
        <span style="color: #0000ff;">return</span> __raw_readb(partition-&gt;<span style="color: #0000ff;">base</span> + reg);                                    | |
    <span style="color: #0000ff;">else</span>                                                                              | |
        <span style="color: #0000ff;">return</span> __raw_readw(partition-&gt;<span style="color: #0000ff;">base</span> + reg);                                    | |<span style="color: #000000;">
}                                                                                     </span>| |
                                                                                      | |
<span style="color: #0000ff;">void</span> omap_mux_write(<span style="color: #0000ff;">struct</span> omap_mux_partition *partition, u16 val,            &lt;-------+ |<span style="color: #000000;">
               u16 reg)                                                                 </span>|<span style="color: #000000;">
{                                                                                       </span>|
    <span style="color: #0000ff;">if</span> (partition-&gt;flags &amp; OMAP_MUX_REG_8BIT)                                           |<span style="color: #000000;">
        __raw_writeb(val, partition</span>-&gt;<span style="color: #0000ff;">base</span> + reg);                                       |
    <span style="color: #0000ff;">else</span>                                                                                |<span style="color: #000000;">
        __raw_writew(val, partition</span>-&gt;<span style="color: #0000ff;">base</span> + reg);                                       |<span style="color: #000000;">
}                                                                                       </span>|
                                                                                        |
                                                                                        |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> platform_device leds_gpio = {                         &lt;-------------------+<span style="color: #000000;">
    .name    </span>= <span style="color: #800000;">"</span><span style="color: #800000;">leds-gpio</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    .id    </span>= -<span style="color: #800080;">1</span><span style="color: #000000;">,
    .dev    </span>=<span style="color: #000000;"> {
        .platform_data    </span>= &amp;<span style="color: #000000;">gpio_led_info,
    },                                 </span>|<span style="color: #000000;">
};                                     </span>|
                                       |<span style="color: #000000;">
                                       V
</span><span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> gpio_led_platform_data gpio_led_info =<span style="color: #000000;"> {
    .leds        </span>= gpio_leds,             -------+<span style="color: #000000;">
    .num_leds    </span>= ARRAY_SIZE(gpio_leds),        |<span style="color: #000000;">
};                                               </span>|
                                                 |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> gpio_led gpio_leds[] = {    &lt;------+<span style="color: #000000;">
    {
        .name            </span>= <span style="color: #800000;">"</span><span style="color: #800000;">usr0</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        .gpio            </span>= GPIO_TO_PIN(<span style="color: #800080;">1</span>, <span style="color: #800080;">16</span>),    <span style="color: #008000;">/*</span><span style="color: #008000;"> D1 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
        .active_low        </span>= <span style="color: #800080;">1</span><span style="color: #000000;">,
    },
    {
        .name            </span>= <span style="color: #800000;">"</span><span style="color: #800000;">usr1</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        .gpio            </span>= GPIO_TO_PIN(<span style="color: #800080;">1</span>, <span style="color: #800080;">17</span>),    <span style="color: #008000;">/*</span><span style="color: #008000;"> D2 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
        .active_low        </span>= <span style="color: #800080;">1</span><span style="color: #000000;">,
    },
    {
        .name            </span>= <span style="color: #800000;">"</span><span style="color: #800000;">usr2</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        .gpio            </span>= GPIO_TO_PIN(<span style="color: #800080;">1</span>, <span style="color: #800080;">18</span>),    <span style="color: #008000;">/*</span><span style="color: #008000;"> D3 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
        .active_low        </span>= <span style="color: #800080;">1</span><span style="color: #000000;">,
    },
    {
        .name            </span>= <span style="color: #800000;">"</span><span style="color: #800000;">usr3</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        .gpio            </span>= GPIO_TO_PIN(<span style="color: #800080;">1</span>, <span style="color: #800080;">19</span>),    <span style="color: #008000;">/*</span><span style="color: #008000;"> D4 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
        .active_low        </span>= <span style="color: #800080;">1</span><span style="color: #000000;">,
    },
    {
        .name            </span>= <span style="color: #800000;">"</span><span style="color: #800000;">heartbeat</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        .gpio            </span>= GPIO_TO_PIN(<span style="color: #800080;">3</span>, <span style="color: #800080;">8</span>),    <span style="color: #008000;">/*</span><span style="color: #008000;"> D4 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
        .default_trigger    </span>= <span style="color: #800000;">"</span><span style="color: #800000;">heartbeat</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    },
};

驱动注册
</span><span style="color: #008000;">//</span><span style="color: #008000;"> linux/drivers/gpio/gpio-omap.c</span>
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> __init omap_gpio_drv_reg(<span style="color: #0000ff;">void</span><span style="color: #000000;">)
{
    </span><span style="color: #0000ff;">return</span> platform_driver_register(&amp;omap_gpio_driver);    -----------+<span style="color: #000000;">
}                                                                     </span>|<span style="color: #000000;">
postcore_initcall(omap_gpio_drv_reg);                                 </span>|
                                                                      |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> __init omap_gpio_sysinit(<span style="color: #0000ff;">void</span>)                             |<span style="color: #000000;">
{                                                                     </span>|<span style="color: #000000;">
    mpuio_init();                                                     </span>|
                                                                      |
<span style="color: #0000ff;">#if</span> defined(CONFIG_ARCH_OMAP16XX) || defined(CONFIG_ARCH_OMAP2PLUS)   |
    <span style="color: #0000ff;">if</span> (cpu_is_omap16xx() || cpu_class_is_omap2())                    |<span style="color: #000000;">
        register_syscore_ops(</span>&amp;omap_gpio_syscore_ops);                 |
<span style="color: #0000ff;">#endif</span>                                                                |
                                                                      |
    <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span>;                                                         |<span style="color: #000000;">
}                                                                     </span>|
                                                                      |<span style="color: #000000;">
arch_initcall(omap_gpio_sysinit);                                     </span>|
                                                                      |
                                                                      |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> platform_driver omap_gpio_driver = {        &lt;-----------+<span style="color: #000000;">
    .probe        </span>= omap_gpio_probe,   -----+<span style="color: #000000;">
    .driver        </span>= {                      |<span style="color: #000000;">
        .name    </span>= <span style="color: #800000;">"</span><span style="color: #800000;">omap_gpio</span><span style="color: #800000;">"</span>,             |<span style="color: #000000;">
    },                                      </span>|<span style="color: #000000;">
};                                          </span>|<span style="color: #000000;">
                                            V
</span><span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> __devinit omap_gpio_probe(<span style="color: #0000ff;">struct</span> platform_device *<span style="color: #000000;">pdev)
{
    </span><span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> gpio_init_done;
    </span><span style="color: #0000ff;">struct</span> omap_gpio_platform_data *<span style="color: #000000;">pdata;
    </span><span style="color: #0000ff;">struct</span> resource *<span style="color: #000000;">res;
    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> id;
    </span><span style="color: #0000ff;">struct</span> gpio_bank *<span style="color: #000000;">bank;

    </span><span style="color: #0000ff;">if</span> (!pdev-&gt;<span style="color: #000000;">dev.platform_data)
        </span><span style="color: #0000ff;">return</span> -<span style="color: #000000;">EINVAL;

    pdata </span>= pdev-&gt;<span style="color: #000000;">dev.platform_data;

    </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">gpio_init_done) {
        </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> ret;

        ret </span>=<span style="color: #000000;"> init_gpio_info(pdev);
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (ret)
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> ret;
    }

    id </span>= pdev-&gt;<span style="color: #000000;">id;
    bank </span>= &amp;<span style="color: #000000;">gpio_bank[id];

    res </span>= platform_get_resource(pdev, IORESOURCE_IRQ, <span style="color: #800080;">0</span><span style="color: #000000;">);
    </span><span style="color: #0000ff;">if</span> (unlikely(!<span style="color: #000000;">res)) {
        dev_err(</span>&amp;pdev-&gt;dev, <span style="color: #800000;">"</span><span style="color: #800000;">GPIO Bank %i Invalid IRQ resource\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, id);
        </span><span style="color: #0000ff;">return</span> -<span style="color: #000000;">ENODEV;
    }

    bank</span>-&gt;irq = res-&gt;<span style="color: #000000;">start;
    bank</span>-&gt;virtual_irq_start = pdata-&gt;<span style="color: #000000;">virtual_irq_start;
    bank</span>-&gt;method = pdata-&gt;<span style="color: #000000;">bank_type;
    bank</span>-&gt;dev = &amp;pdev-&gt;<span style="color: #000000;">dev;
    bank</span>-&gt;dbck_flag = pdata-&gt;<span style="color: #000000;">dbck_flag;
    bank</span>-&gt;stride = pdata-&gt;<span style="color: #000000;">bank_stride;
    bank</span>-&gt;width = pdata-&gt;<span style="color: #000000;">bank_width;

    bank</span>-&gt;regs = pdata-&gt;regs;       <span style="color: #008000;">//</span><span style="color: #008000;">将寄存器地址复制给bank-&gt;regs结构体</span>

    <span style="color: #0000ff;">if</span> (bank-&gt;regs-&gt;set_dataout &amp;&amp; bank-&gt;regs-&gt;<span style="color: #000000;">clr_dataout)
        bank</span>-&gt;set_dataout =<span style="color: #000000;"> _set_gpio_dataout_reg;
    </span><span style="color: #0000ff;">else</span><span style="color: #000000;">
        bank</span>-&gt;set_dataout =<span style="color: #000000;"> _set_gpio_dataout_mask;

    spin_lock_init(</span>&amp;bank-&gt;<span style="color: #0000ff;">lock</span><span style="color: #000000;">);

    </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Static mapping, never released </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    res </span>= platform_get_resource(pdev, IORESOURCE_MEM, <span style="color: #800080;">0</span><span style="color: #000000;">);
    </span><span style="color: #0000ff;">if</span> (unlikely(!<span style="color: #000000;">res)) {
        dev_err(</span>&amp;pdev-&gt;dev, <span style="color: #800000;">"</span><span style="color: #800000;">GPIO Bank %i Invalid mem resource\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, id);
        </span><span style="color: #0000ff;">return</span> -<span style="color: #000000;">ENODEV;
    }

    bank</span>-&gt;<span style="color: #0000ff;">base</span> = ioremap(res-&gt;<span style="color: #000000;">start, resource_size(res));
    </span><span style="color: #0000ff;">if</span> (!bank-&gt;<span style="color: #0000ff;">base</span><span style="color: #000000;">) {
        dev_err(</span>&amp;pdev-&gt;dev, <span style="color: #800000;">"</span><span style="color: #800000;">Could not ioremap gpio bank%i\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, id);
        </span><span style="color: #0000ff;">return</span> -<span style="color: #000000;">ENOMEM;
    }

    pm_runtime_enable(bank</span>-&gt;<span style="color: #000000;">dev);
    pm_runtime_get_sync(bank</span>-&gt;<span style="color: #000000;">dev);

    omap_gpio_mod_init(bank, id);         </span>-----------------------------------+<span style="color: #000000;">
    omap_gpio_chip_init(bank);        </span>------------------------------+        |<span style="color: #000000;">
    omap_gpio_show_rev(bank);  </span>---+                                 |        |
                                  |                                 |        |
    <span style="color: #0000ff;">if</span> (!gpio_init_done)          |                                 |        |<span style="color: #000000;">
        gpio_init_done </span>= <span style="color: #800080;">1</span>;       |                                 |        |
                                  |                                 |        |
    <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span>;                     |                                 |        |<span style="color: #000000;">
}                                 </span>|                                 |        |
<span style="color: #008000;">//</span><span style="color: #008000;">查看版本号并打印                  V                                 |        |</span>
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> __init omap_gpio_show_rev(<span style="color: #0000ff;">struct</span> gpio_bank *bank)       |        |<span style="color: #000000;">
{                                                                   </span>|        |
    <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">bool</span> called;                                             |        |<span style="color: #000000;">
    u32 rev;                                                        </span>|        |
                                                                    |        |
    <span style="color: #0000ff;">if</span> (called || bank-&gt;regs-&gt;revision == USHRT_MAX)                |        |
        <span style="color: #0000ff;">return</span>;                                                     |        |
                                                                    |        |<span style="color: #000000;">
    rev </span>= __raw_readw(bank-&gt;<span style="color: #0000ff;">base</span> + bank-&gt;regs-&gt;revision);           |        |<span style="color: #000000;">
    pr_info(</span><span style="color: #800000;">"</span><span style="color: #800000;">OMAP GPIO hardware version %d.%d\n</span><span style="color: #800000;">"</span>,                   |        |<span style="color: #000000;">
        (rev </span>&gt;&gt; <span style="color: #800080;">4</span>) &amp; <span style="color: #800080;">0x0f</span>, rev &amp; <span style="color: #800080;">0x0f</span>);                             |        |
                                                                    |        |<span style="color: #000000;">
    called </span>= <span style="color: #0000ff;">true</span>;                                                  |        |<span style="color: #000000;">
}                                                                   </span>|        |
                                                                    |        |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> __devinit omap_gpio_chip_init(<span style="color: #0000ff;">struct</span> gpio_bank *bank) &lt;-+        |<span style="color: #000000;">
{                                                                            </span>|
    <span style="color: #0000ff;">int</span> j;                                                                   |
    <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> gpio;                                                         |
                                                                             |<span style="color: #000000;">
    bank</span>-&gt;mod_usage = <span style="color: #800080;">0</span>;                                                     |
    <span style="color: #008000;">/*</span><span style="color: #008000;">                                                                       |
     * REVISIT eventually switch from OMAP-specific gpio structs             |
     * over to the generic ones                                              |
     </span><span style="color: #008000;">*/</span>                                                                      |<span style="color: #000000;">
    bank</span>-&gt;chip.request = omap_gpio_request;                                  |<span style="color: #000000;">
    bank</span>-&gt;chip.<span style="color: #0000ff;">free</span> = omap_gpio_free;                                        |<span style="color: #000000;">
    bank</span>-&gt;chip.direction_input = gpio_input;             ----------+         |<span style="color: #000000;">
    bank</span>-&gt;chip.<span style="color: #0000ff;">get</span> = gpio_get;                                     |         |<span style="color: #000000;">
    bank</span>-&gt;chip.direction_output = gpio_output;                     |         |<span style="color: #000000;">
    bank</span>-&gt;chip.set_debounce = gpio_debounce;                       |         |<span style="color: #000000;">
    bank</span>-&gt;chip.<span style="color: #0000ff;">set</span> = gpio_set;                                     |         |<span style="color: #000000;">
    bank</span>-&gt;chip.to_irq = gpio_2irq;                                 |         |
    <span style="color: #0000ff;">if</span> (bank_is_mpuio(bank)) {                                     |         |<span style="color: #000000;">
        bank</span>-&gt;chip.label = <span style="color: #800000;">"</span><span style="color: #800000;">mpuio</span><span style="color: #800000;">"</span>;                                |         |<span style="color: #000000;">
#ifdef CONFIG_ARCH_OMAP16XX                                        </span>|         |<span style="color: #000000;">
        bank</span>-&gt;chip.dev = &amp;omap_mpuio_device.dev;                   |         |
<span style="color: #0000ff;">#endif</span>                                                             |         |<span style="color: #000000;">
        bank</span>-&gt;chip.<span style="color: #0000ff;">base</span> = OMAP_MPUIO(<span style="color: #800080;">0</span>);                           |         |<span style="color: #000000;">
    } </span><span style="color: #0000ff;">else</span> {                                                       |         |<span style="color: #000000;">
        bank</span>-&gt;chip.label = <span style="color: #800000;">"</span><span style="color: #800000;">gpio</span><span style="color: #800000;">"</span>;                                 |         |<span style="color: #000000;">
        bank</span>-&gt;chip.<span style="color: #0000ff;">base</span> = gpio;                                    |         |<span style="color: #000000;">
        gpio </span>+= bank-&gt;width;                                       |         |<span style="color: #000000;">
    }                                                              </span>|         |<span style="color: #000000;">
    bank</span>-&gt;chip.ngpio = bank-&gt;width;                                |         |
                                                                   |         |<span style="color: #000000;">
    gpiochip_add(</span>&amp;bank-&gt;chip);                                     |         |
                                                                   |         |
    <span style="color: #0000ff;">for</span> (j = bank-&gt;virtual_irq_start;                              |         |<span style="color: #000000;">
             j </span>&lt; bank-&gt;virtual_irq_start + bank-&gt;width; j++) {     |         |<span style="color: #000000;">
        irq_set_lockdep_class(j, </span>&amp;gpio_lock_class);                |         |<span style="color: #000000;">
        irq_set_chip_data(j, bank);                                </span>|         |
        <span style="color: #0000ff;">if</span> (bank_is_mpuio(bank)) {                                 |         |<span style="color: #000000;">
            omap_mpuio_alloc_gc(bank, j, bank</span>-&gt;width);             |         |<span style="color: #000000;">
        } </span><span style="color: #0000ff;">else</span> {                                                   |         |<span style="color: #000000;">
            irq_set_chip(j, </span>&amp;gpio_irq_chip);                       |         |<span style="color: #000000;">
            irq_set_handler(j, handle_simple_irq);                 </span>|         |<span style="color: #000000;">
            set_irq_flags(j, IRQF_VALID);                          </span>|         |<span style="color: #000000;">
        }                                                          </span>|         |<span style="color: #000000;">
    }                                                              </span>|         |<span style="color: #000000;">
    irq_set_chained_handler(bank</span>-&gt;irq, gpio_irq_handler);          |         |<span style="color: #000000;">
    irq_set_handler_data(bank</span>-&gt;irq, bank);                         |         |<span style="color: #000000;">
}                                                                  </span>|         |
                                                                   |         |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> gpio_input(<span style="color: #0000ff;">struct</span> gpio_chip *chip, unsigned offset)  &lt;--+         |<span style="color: #000000;">
{                                                                            </span>|
    <span style="color: #0000ff;">struct</span> gpio_bank *bank;                                                  |<span style="color: #000000;">
    unsigned </span><span style="color: #0000ff;">long</span> flags;                                                     |
                                                                             |<span style="color: #000000;">
    bank </span>= container_of(chip, <span style="color: #0000ff;">struct</span> gpio_bank, chip);                       |<span style="color: #000000;">
    spin_lock_irqsave(</span>&amp;bank-&gt;<span style="color: #0000ff;">lock</span>, flags);                                   |<span style="color: #000000;">
    _set_gpio_direction(bank, offset, </span><span style="color: #800080;">1</span>);                          --------+ |<span style="color: #000000;">
    spin_unlock_irqrestore(</span>&amp;bank-&gt;<span style="color: #0000ff;">lock</span>, flags);                            | |
    <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span>;                                                              | |<span style="color: #000000;">
}                                                                          </span>| |
                                                                           | |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> _set_gpio_direction(<span style="color: #0000ff;">struct</span> gpio_chip *chip, unsigned offset, &lt;-+ |
                <span style="color: #0000ff;">int</span> dir)                                                     |<span style="color: #000000;">
{                                                                            </span>|<span style="color: #000000;">
    unsigned </span><span style="color: #0000ff;">int</span> <span style="color: #0000ff;">base</span> = GPIO_BASE(offset / <span style="color: #800080;">32</span>);                              |<span style="color: #000000;">
    unsigned </span><span style="color: #0000ff;">int</span> reg;                                                        |
                                                                             |<span style="color: #000000;">
    reg </span>= __raw_readl(<span style="color: #0000ff;">base</span> + GPIO_DIR);                                      |
    <span style="color: #0000ff;">if</span> (dir)                                                                 |<span style="color: #000000;">
        reg </span>|= <span style="color: #800080;">1</span> &lt;&lt; (offset % <span style="color: #800080;">32</span>);                                           |
    <span style="color: #0000ff;">else</span>                                                                     |<span style="color: #000000;">
        reg </span>&amp;= ~(<span style="color: #800080;">1</span> &lt;&lt; (offset % <span style="color: #800080;">32</span>));                                        |<span style="color: #000000;">
    __raw_writel(reg, </span><span style="color: #0000ff;">base</span> + GPIO_DIR);                                      |<span style="color: #000000;">
}                                                                            </span>|
                                                                             |
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> omap_gpio_mod_init(<span style="color: #0000ff;">struct</span> gpio_bank *bank, <span style="color: #0000ff;">int</span> id)         &lt;-----+<span style="color: #000000;">
{
    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (cpu_class_is_omap2()) {
        </span><span style="color: #0000ff;">if</span> (cpu_is_omap44xx() ||<span style="color: #000000;"> cpu_is_am33xx()) {
            __raw_writel(</span><span style="color: #800080;">0xffffffff</span>, bank-&gt;<span style="color: #0000ff;">base</span> +<span style="color: #000000;">
                    OMAP4_GPIO_IRQSTATUSCLR0);
            __raw_writel(</span><span style="color: #800080;">0x00000000</span>, bank-&gt;<span style="color: #0000ff;">base</span> +<span style="color: #000000;">
                     OMAP4_GPIO_DEBOUNCENABLE);
            </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Initialize interface clk ungated, module enabled </span><span style="color: #008000;">*/</span><span style="color: #000000;">
            __raw_writel(</span><span style="color: #800080;">0</span>, bank-&gt;<span style="color: #0000ff;">base</span> +<span style="color: #000000;"> OMAP4_GPIO_CTRL);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> (cpu_is_omap34xx()) {
            __raw_writel(</span><span style="color: #800080;">0x00000000</span>, bank-&gt;<span style="color: #0000ff;">base</span> +<span style="color: #000000;">
                    OMAP24XX_GPIO_IRQENABLE1);
            __raw_writel(</span><span style="color: #800080;">0xffffffff</span>, bank-&gt;<span style="color: #0000ff;">base</span> +<span style="color: #000000;">
                    OMAP24XX_GPIO_IRQSTATUS1);
            __raw_writel(</span><span style="color: #800080;">0x00000000</span>, bank-&gt;<span style="color: #0000ff;">base</span> +<span style="color: #000000;">
                    OMAP24XX_GPIO_DEBOUNCE_EN);

            </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Initialize interface clk ungated, module enabled </span><span style="color: #008000;">*/</span><span style="color: #000000;">
            __raw_writel(</span><span style="color: #800080;">0</span>, bank-&gt;<span style="color: #0000ff;">base</span> +<span style="color: #000000;"> OMAP24XX_GPIO_CTRL);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> (cpu_is_omap24xx()) {
            </span><span style="color: #0000ff;">static</span> <span style="color: #0000ff;">const</span> u32 non_wakeup_gpios[] =<span style="color: #000000;"> {
                </span><span style="color: #800080;">0xe203ffc0</span>, <span style="color: #800080;">0x08700040</span><span style="color: #000000;">
            };
            </span><span style="color: #0000ff;">if</span> (id &lt;<span style="color: #000000;"> ARRAY_SIZE(non_wakeup_gpios))
                bank</span>-&gt;non_wakeup_gpios =<span style="color: #000000;"> non_wakeup_gpios[id];
        }
    } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> (cpu_class_is_omap1()) {
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bank_is_mpuio(bank))
            __raw_writew(</span><span style="color: #800080;">0xffff</span>, bank-&gt;<span style="color: #0000ff;">base</span> +<span style="color: #000000;">
                OMAP_MPUIO_GPIO_MASKIT </span>/ bank-&gt;<span style="color: #000000;">stride);
        </span><span style="color: #0000ff;">if</span> (cpu_is_omap15xx() &amp;&amp; bank-&gt;method ==<span style="color: #000000;"> METHOD_GPIO_1510) {
            __raw_writew(</span><span style="color: #800080;">0xffff</span>, bank-&gt;<span style="color: #0000ff;">base</span>
                        +<span style="color: #000000;"> OMAP1510_GPIO_INT_MASK);
            __raw_writew(</span><span style="color: #800080;">0x0000</span>, bank-&gt;<span style="color: #0000ff;">base</span>
                        +<span style="color: #000000;"> OMAP1510_GPIO_INT_STATUS);
        }
        </span><span style="color: #0000ff;">if</span> (cpu_is_omap16xx() &amp;&amp; bank-&gt;method ==<span style="color: #000000;"> METHOD_GPIO_1610) {
            __raw_writew(</span><span style="color: #800080;">0x0000</span>, bank-&gt;<span style="color: #0000ff;">base</span>
                        +<span style="color: #000000;"> OMAP1610_GPIO_IRQENABLE1);
            __raw_writew(</span><span style="color: #800080;">0xffff</span>, bank-&gt;<span style="color: #0000ff;">base</span>
                        +<span style="color: #000000;"> OMAP1610_GPIO_IRQSTATUS1);
            __raw_writew(</span><span style="color: #800080;">0x0014</span>, bank-&gt;<span style="color: #0000ff;">base</span>
                        +<span style="color: #000000;"> OMAP1610_GPIO_SYSCONFIG);

            </span><span style="color: #008000;">/*</span><span style="color: #008000;">
             * Enable system clock for GPIO module.
             * The CAM_CLK_CTRL *is* really the right place.
             </span><span style="color: #008000;">*/</span><span style="color: #000000;">
            omap_writel(omap_readl(ULPD_CAM_CLK_CTRL) </span>| <span style="color: #800080;">0x04</span><span style="color: #000000;">,
                        ULPD_CAM_CLK_CTRL);
        }
        </span><span style="color: #0000ff;">if</span> (cpu_is_omap7xx() &amp;&amp; bank-&gt;method ==<span style="color: #000000;"> METHOD_GPIO_7XX) {
            __raw_writel(</span><span style="color: #800080;">0xffffffff</span>, bank-&gt;<span style="color: #0000ff;">base</span>
                        +<span style="color: #000000;"> OMAP7XX_GPIO_INT_MASK);
            __raw_writel(</span><span style="color: #800080;">0x00000000</span>, bank-&gt;<span style="color: #0000ff;">base</span>
                        +<span style="color: #000000;"> OMAP7XX_GPIO_INT_STATUS);
        }
    }
}</span></pre>
</div>
<p>&nbsp;</p>